<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<style>
			.mui-tab-item {
				width: 50px!important;
			}
			
			.mui-content img {
				width: 100%;
			}
			
			.line {
				width: 100%;
				height: 1px;
				margin-top: 10px;
				margin-bottom: 10px;
				background: #f2f2f2;
			}
			
			.line2 {
				width: 100%;
				height: 1px;
				background: #f2f2f2;
			}
			
			.img-juxing {
				max-width: 5px;
				height: 15px;
				/*margin-right: 10px;
				margin-top: 10px;
				margin-left: 10px;*/
				margin: 0px 10px;
			}
			
			.mui-row {
				background: white!important;
				margin-top: 10px;
				padding: 10px 0px;
			}
			
			#arrange {
				width: 150px;
				height: 40px;
				background: url(images/img11.png) no-repeat;
				background-size: contain;
				color: white;
				border: none;
				margin-right: 20px;
			}
			
			.mui-card {
				margin: 10px;
				border: none;
				border-radius: 0px;
			}
			
			.mui-content {
				padding-bottom: 50px;
			}
			
			.avatar {
				clear: both;
				display: block;
				margin: auto;
				border-radius: 30px;
				width: 60px!important;
				height: 60px;
				margin-right: 20px;
			}
			
			.stars {
				width: 15px!important;
				height: 15px;
			}
			
			.mui-card-content img {
				height: 150px;
			}
			
			.comment {
				padding: 0px;
			}
			
			#commentNo {
				margin-right: 20px;
				color: gainsboro;
			}
			
			#mui-template {
				padding: 0px;
				background: #F2F2F2!important;
			}
			
			.text-left {
				margin-left: 10px;
			}
			
			#toClass {
				margin-left: -30px;
			}
			
			.mui-card-footer {
				margin: 2px;
			}
			
			#last-row {
				padding-bottom: 0px;
			}
			
			#lijilingqu {
				background: red;
				color: white;
				height: 100%;
				line-height: 50px;
			}
			
			#couponImg {
				height: 20px;
				max-width: 15px;
				margin-left: 10px;
				margin-right: 10px;
				/*margin: 15px 15px;*/
			}
			
			#counpon {
				padding: 0px;
				height: 50px;
			}
			
			.mui-col-sm-8 {
				padding-top: 15px;
				color: red;
			}
			
			.mui-icon img {
				height: 15px;
			}
			
			#start_price {
				line-height: 58px;
				color: red;
				margin-left: 20px;
			}
			.mui-bar-tab .mui-tab-item.mui-active{
				color: #929292;
			}
			/*.mui-table-view:before{
				height: 0px;
			}
			.mui-table-view:after{
				height: 0px;
			}*/
			#noticeImg{
				height: 20px;
				width: 20px;
				margin: 10px 0 0 10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">服务</h1>
			<button class="mui-btn mui-btn-blue mui-btn-link mui-pull-right">
				<img id='noticeImg' src="images/ic_share.png" />
			</button>
		</header>
		<div class="mui-content">
			<div>
				<img id="good_img" />
			</div>
			<div class="mui-row" id="counpon">
				<div class="mui-col-xs-8 mui-col-sm-8">
					<img src="images/ic_display.png" id="couponImg" /> 领取店铺优惠券
				</div>
				<div class="mui-col-xs-4 mui-col-sm-4 mui-text-center" id="lijilingqu">
					立即领取
				</div>
			</div>
			<!--<div class="mui-row" id="counpon">
				<div class="mui-col-xs-8 mui-col-sm-8">
					<img src="images/ic_display.png"/>
				</div>
				<div class="mui-col-xs-4 mui-col-sm-4 mui-text-center" id="lijilingqu" >
					立即领取
				</div>
			</div>-->
			<div class="mui-row">
				<div id="good_name" class="text-left">
				</div>
				<div class="line"></div>
				<span id="good_intro" style="color: darkgrey;" class="text-left"></span>
			</div>
			<!--<div class="mui-row" >
				
			</div>
			<div class="mui-row" id="youhuiquan"></div>-->
			<div class="mui-row">
				<div><img src="images/img84.png" class="img-juxing" />服务价格</div>
				<div class="line"></div>
				<div id="price" class="text-left"></div>
			</div>
			<div class="mui-row">
				<div><img src="images/img84.png" class="img-juxing" />服务介绍</div>
				<div class="line"></div>
				<div id="info" class="text-left"></div>
			</div>

			<div class="mui-row comment">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<a class="mui-navigate-right" id="toClass">
							<img src="images/img84.png" class="img-juxing" />用户评论<span class="mui-pull-right" id="commentNo"></span>
						</a>
					</li>
				</ul>
				<div id="sheet1" class="mui-popover mui-popover-bottom mui-popover-action " style="background: white;">
					<div class="mui-row mui-text-center">店铺优惠券</div>
					<!-- 可选择菜单 -->
					<!--<ul class="mui-table-view">
      <!--<li class="mui-table-view-cell">
        <a href="#">菜单1</a>
      </li>
      <li class="mui-table-view-cell">
        <a href="#">菜单2</a>
      </li>-->
					<!-- 取消菜单 -->
					<ul class="mui-table-view" style="background-image: url(images/img10.png);">
						<li class="mui-table-view-cell">
							<a href="#sheet1" style="color: white;border-radius: 0;"><b>完成</b></a>
						</li>
					</ul>
				</div>
				<!--<div>-->
				<!--<img src="images/img84.png" class="img-juxing" />用户评论</div>-->
				<!--<div class="line"></div>-->
				<div id="mui-template2" class="text-left">
					<script type="text/template" id="temp2">
						<% for(var i in record){ var item=record[i]; %>

						<div class="mui-row">
							<div class="mui-pull-left">
								<img src="<%=item.mbi_photo_thum || 'images/img54.png'%>" class="avatar" />
								<!--<img src="<%=item.mbi_photo_thum%>"/>-->
							</div>
							<!--<div class="mui-pull-right">-->
							<div><img src="images/img81.png" class="stars" />
								<img src="images/img81.png" class="stars" />
								<img src="images/img81.png" class="stars" />
								<img src="images/img81.png" class="stars" />
								<img src="images/img81.png" class="stars" /></div>
							<div>
								<%=item.jzc_content%>
							</div>
							<!--</div>-->
						</div>
						<!--<div class="line2"></div>-->
						<%}%>
					</script>
				</div>
			</div>
			<div class="mui-row" id="last-row">
				<div><img src="images/img84.png" class="img-juxing" />推荐</div>
				<div class="mui-row" id="mui-template">
					<script type="text/template" id="temp">
						<% for(var i in record){ var item=record[i]; %>
						<div class="mui-col-sm-6 mui-col-xs-6">
							<div class="mui-card">
								<div class="mui-card-content">
									<img id="<%=item.jg_id%>" src="<%=item.jg_img%>" />
								</div>
								<div class="mui-card-footer">
									<%=item.jg_name%>
								</div>
								<div class="mui-card-footer">
									<h5><%=item.jg_intro%></h5>
								</div>
							</div>
						</div>
						<%}%>
					</script>
					<!--<div class="mui-col-sm-6">
						<div class="mui-card">
							<div class="mui-card-content"><img src="images/img87.png" /></div>
							<div class="mui-card-footer">专业家电维修，各种热水器维修</div>
						</div>
					</div>-->
				</div>
			</div>

		</div>
		</div>
		<div class="mui-content-padded">
			<nav class="mui-bar mui-bar-tab">
				<a class="mui-tab-item" id="shopInfo">
					<span class="iconstyle mui-icon ">
							<img src="images/ic_company_bt.png" />
						</span>
					<span class="mui-tab-label">商家</span>
				</a>
				<a class="mui-tab-item" id="collect">
					<span class="iconstyle mui-icon ">
							<img src="images/ic_comment_normal.png" id="collectImg"/>
						</span>
					<span class="mui-tab-label">收藏</span>
				</a>
				<span id="start_price"> </span>
				<button type="button" class="mui-btn mui-pull-right" id="arrange">立即预约</button>
			</nav>
		</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js"></script>
		<script type="text/javascript" src="js/xiachenshi.js"></script>
		<script type="text/javascript" src="js/arttmpl.js"></script>
		<script type="text/javascript">
			var isCollect = 1;
			var shares = null;
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				self.show('slide-in-right', 300);
				plus.nativeUI.closeWaiting();
				updateSerivces();
				
				var loginData = JSON.parse(localStorage.getItem('login'));
				if(!loginData) {
					return;
				}
				
				var mbi_id = loginData.data.info.mbi_id;
				var good_id = self.good_id;
				if(good_id) {
					getGoodInfo(good_id, mbi_id);
					getCommentList(good_id);
				}
				document.getElementById('lijilingqu').addEventListener('tap', function() {
					mui('#sheet1').popover('toggle');
				})
				document.getElementById('noticeImg').addEventListener('tap', function(){
					shareShow();
				})
			})
			
			function updateSerivces() {
				plus.share.getServices(function(s) {
					shares = {};
					for(var i in s) {
						var t = s[i];
						shares[t.id] = t;
					}
				}, function(e) {
					console.log('获取分享服务列表失败：' + e.message);
				});
			}
			
			function shareShow() {
				var shareBts = [];
				// 更新分享列表
				var ss = shares['weixin'];
				if(navigator.userAgent.indexOf('qihoo') < 0) { //在360流应用中微信不支持分享图片
					ss && ss.nativeClient && (shareBts.push({
							title: '微信朋友圈',
							s: ss,
							x: 'WXSceneTimeline'
						}),
						shareBts.push({
							title: '微信好友',
							s: ss,
							x: 'WXSceneSession'
						}));
				}
				ss = shares['qq'];
				ss && ss.nativeClient && shareBts.push({
					title: 'QQ',
					s: ss
				});
				// 弹出分享列表
				shareBts.length > 0 ? plus.nativeUI.actionSheet({
					title: '分享',
					cancel: '取消',
					buttons: shareBts
				}, function(e) {
					(e.index > 0) && shareAction(shareBts[e.index - 1], false);
				}) : plus.nativeUI.alert('当前环境无法支持分享操作!');
			}
			
			function shareAction(sb, bh) {
				console.log('分享操作：');
				if(!sb || !sb.s) {
					console.log('无效的分享服务！');
					return;
				}
				var msg = {
					content: "test",
					extra: {
						scene: sb.x
					}
				};
				if(bh) {
//					msg.href = sharehref.value;
//					if(sharehrefTitle && sharehrefTitle.value != '') {
//						msg.title = sharehrefTitle.value;
//					}
//					if(sharehrefDes && sharehrefDes.value != '') {
//						msg.content = sharehrefDes.value;
//					}
//					msg.thumbs = ['_www/logo.png'];
//					msg.pictures = ['_www/logo.png'];
				} else {
					if(pic && pic.realUrl) {
						msg.pictures = [pic.realUrl];
					}
				}
				// 发送分享
				if(sb.s.authenticated) {
					console.log('---已授权---');
					shareMessage(msg, sb.s);
				} else {
					console.log('---未授权---');
					sb.s.authorize(function() {
						shareMessage(msg, sb.s);
					}, function(e) {
						console.log('认证授权失败：' + e.code + ' - ' + e.message);
					});
				}
			}
			
			function shareMessage(msg, s) {
				console.log(JSON.stringify(msg));
				s.send(msg, function() {
					console.log('分享到"' + s.description + '"成功！');
				}, function(e) {
					console.log('分享到"' + s.description + '"失败: ' + JSON.stringify(e));
				});
			}

			function getCommentList(good_id) {
				var commentParam = {
					service: 'Hlbr365app.Goods.GetCommentList',
					jg_id: good_id,
					firstRow: 1,
					listRows: 20
				}
				var commentNo = document.getElementById('commentNo');
				commentNo.addEventListener('tap', function() {
					mui.openWindow({
						url: 'comment_list.html',
						id: 'comment_list.html',
						extras: {
							good_id: good_id
						}
					})
				})
				wAjax(commentParam, function(result) {
					var clist = result.data.list;

					commentNo.innerHTML = "" + clist.length + '条评论';
					var str = template('temp2', {
						"record": clist
					});
					document.getElementById("mui-template2").innerHTML = str;
				})
			}

			function getSameGoods(good_id, type_id) {
				var sameGoodsParam = {
					service: 'Hlbr365app.Goods.GetSameServiceList',
					jg_id: good_id,
					two_type_id: type_id,
					city_id: 150702,
					firstRow: 1,
					listRows: 20
				}
				wAjax(sameGoodsParam, function(result) {
					var goodsList = result.data.list;
					var str = template('temp', {
						'record': goodsList
					});
					document.getElementById('mui-template').innerHTML = str;
				})
			}

			function getGoodInfo(good_id, mbi_id) {

				var collectImg = document.getElementById('collectImg');
				document.getElementById('collect').addEventListener('tap', function() {
					collectGood(mbi_id, good_id);
				})

				document.getElementById('arrange').addEventListener('tap', function() {
					mui.openWindow({
						url: 'order_confirm.html',
						id: 'order_confirm.html',
						extras: {
							good_id: good_id
						}
					});
				})

				var getGoodParam = {
					service: 'Hlbr365app.Goods.GetGoodsInfo',
					jg_id: good_id
				}
				wAjax(getGoodParam, function(result) {
					var info = result.data.info;
					document.getElementById('good_img').src = info.jg_img || 'images/img16.png';
					document.getElementById('good_name').innerHTML = info.jg_name;
					document.getElementById('good_intro').innerHTML = info.jg_intro;
					document.getElementById('price').innerHTML = info.jg_price;
					document.getElementById('start_price').innerHTML = info.jg_price_start;
					isCollect = info.isCollect;
					var type_id = info.two_type_id;
					var coupon = info.coupon;
					document.getElementById('counpon').hidden = coupon.length < 1;
					
					getSameGoods(good_id, type_id);

					document.getElementById('shopInfo').addEventListener('tap', function() {
						mui.openWindow({
							url: 'shop_info.html',
							id: 'shop_info.html',
							extras: {
								shop_id: info.jci_id
							}
						})
					})

					if(isCollect == 1) {
						collectImg.src = "images/ic_comment_press.png";
					} else if(isCollect == 2) {
						collectImg.src = "images/ic_comment_normal.png";
					}
					// 实体字符转换
					var ele = document.createElement('div');
					ele.innerHTML = info.jg_content;
					document.getElementById('info').innerHTML = ele.innerText;
					plus.nativeUI.closeWaiting();
				})
			}

			function collectGood(mbi_id, good_id) {
				var action = (isCollect == 1) ? 2 : 1;
				var collectParam = {
					service: 'Hlbr365app.Goods.SetCollect',
					mbi_id: mbi_id,
					jc_type: 1,
					jc_wid: good_id,
					action: action
				};
				wAjax(collectParam, function(result) {
					if(action == 1) {
						collectImg.src = "images/ic_comment_press.png";
						isCollect = 1;
					} else if(action == 2) {
						collectImg.src = "images/ic_comment_normal.png";
						isCollect = 2;
					}
					//					isCollect = !isCollect;
				})
			}

			mui("#mui-template").on('tap', 'img', function(e) {
				var id = this.getAttribute("id");
				window.scrollTo(0, 0);
				showWaiting();
				setTimeout(function() {
					getGoodInfo(id);
				}, 100)

				//					mui.refresh();
				//					plus.webview.currentWebview().reload();

				//					mui.openWindow({
				//						url: 'goods_info.html',
				//						id: 'goods_info.html',
				//						extras: {
				//							good_id: id
				//						}
				//					});
			});
		</script>
	</body>

</html>