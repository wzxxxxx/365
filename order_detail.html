<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<!--<link rel="stylesheet" href="css/mui.dtpicker.css" />-->
		<link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
		<style>
		.mui-row input {
				border-style: none;
				line-height: 30px;
				width: 80%;
				margin: 0;
			}
			
			.bg-address {
				height: 5px;
				width: 100%;
				position: fixed;
			}
			
			.mui-content {
				padding-top: 54px!important;
			}
			
			.mui-row {
				background: white;
				margin-top: 10px;
				padding: 10px;
			}
			/*#noAddr {
				height: 50px;
				line-height: 50px;
				font-size: small;
				color: gainsboro;
			}*/
			
			.nav-img {
				height: 15px;
				width: 10px;
				margin-left: 8px;
				float: left;
				margin-top: 20px;
			}
			
			#chooseAddress {
				background: white;
			}
			
			.line {
				width: 100%;
				height: 1px;
				margin-top: 10px;
				margin-bottom: 10px;
				background: gainsboro;
			}
			/*.mui-table-view {
				margin-top: 10px;
				border: none;
			}*/
			
			h5 {
				color: black;
			}
			
			#bottomButton {
				width: 150px;
				height: 40px;
				background: url(images/bg_red_bt.png) no-repeat;
				background-size: contain;
				color: white;
				border: none;
				position: fixed;
				bottom: 5px;
				right: 100px;
			}
			
			#price{
				position: fixed;
				bottom: 20px;
				color: red;
				left: 50px;
			}
			
			.firstrow span {
				color: grey;
				margin-left: 5px;
			}
			
			.firstrow {
				margin-bottom: 10px;
			}
			
			.firstrow img {
				height: 15px;
				width: 15px;
				margin-left: 5px;
			}
			#server{
				margin-right: 10px;
				display: inline-block;				
			}
			.mui-pull-right img{
				height: 15px;
				width: 15px;
			}
		}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">订单</h1>
		</header>
		<div class="mui-content">
			<div class="mui-row firstrow">
				<img src="images/ic_order_done.png" /><span id="prompt"></span>
			</div>
			<div id="chooseAddress">
				<img src="images/bg_address.png" class="bg-address" />
				<div>
					<div class="mui-row">
						<div class="mui-col-sm-1 mui-col-xs-1">
							<img src="images/ic_nav_9.png" class="nav-img" />
						</div>
						<div class="mui-col-sm-11 mui-col-xs-11">
							<div>
								<h5 id="name" class="mui-pull-left"></h5>
								<h5 id="phoneNumber" class="mui-pull-right"></h4>
							</div>
							<div>
							<h5 id="address" class="mui-pull-left"> </h5>
							</div>
						</div>
					</div>
					<!--<div id="noAddr" class="mui-text-center">
						<img src="images/ic_nav_9.png" class="nav-img" /> 请选择服务地址
					</div>-->
				</div>
				<img src="images/bg_address.png" class="bg-address" />
			</div>
			<div class="mui-row" id="chooseTime">
				服务时间
				<div class="mui-pull-right" id="time"></div>
			</div>
			<div class="mui-row" id="serverPeople">
				服务人员
				<div class="mui-pull-right"><div id="server"></div><img src="images/ic_phone.png"/></div>
			</div>
			<div class="mui-row">
				<div id="goodName"></div>
				<div class="line"></div>
				<div id="goodIntro"></div>
			</div>
			<div class="mui-row">
				备注
				<div class="mui-pull-left" id="remark"></div>
			</div>
			<div id="submitOrder"></div>

			<!--<div class="mui-row">
			<input placeholder="如有特殊需求,请给商家留言" />
		</div>-->
			<!--<div class="mui-row">
			
		</div>-->
			<!--<div class="mui-row"></div>
		</div>-->
			<div id="price"></div>
			<button type="button" class="mui-btn mui-pull-right mui-hidden" id="bottomButton">提交修改</button>
			<div id="sheet1" class="mui-popover mui-popover-bottom mui-popover-action ">
				<!-- 可选择菜单 -->
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<a href="#">选错服务</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">不想购买服务了</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">商家不接单</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">重复预约</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">服务地址填写有误</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">无法支付订单</a>
					</li>
					<li class="mui-table-view-cell">
						<a href="#">其他</a>
					</li>
				</ul>
			</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/xiachenshi.js"></script>
		<script type="text/javascript" src="js/mui.picker.min.js"></script>
		<!--<script type="text/javascript" src="js/mui.dtpicker.js" ></script>-->
		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript">
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				if(self.order_id) {
					getOrderInfo(self.order_id);
				}
			})

			function getOrderInfo(ob_id) {
				var getOrderParam = {
					service: 'Hlbr365app.Order.GetOrderInfo',
					ob_id: ob_id
				};
				wAjax(getOrderParam, function(result) {
					var info = result.data.info;
					document.getElementById('name').innerHTML = '联系人：' + info.user_contacts_name;
					document.getElementById('phoneNumber').innerHTML = '联系电话：' + info.user_contacts_phone;
					document.getElementById('address').innerHTML = '联系地址：' + info.user_contacts_province_name +
						info.user_contacts_city_name + info.user_contacts_county_name + info.user_contacts_address;
					document.getElementById('time').innerHTML = new Date(1000 * info.user_predict_work_time).toLocaleString();
//					document.getElementById('server').innerHTML = info.customer_user_name;
					document.getElementById('goodName').innerHTML = info.company_name;
					document.getElementById('goodIntro').innerHTML = info.goods.og_goods_name;
					document.getElementById('remark').innerHTML = info.ob_comment_remark;
					if(info.staff){
						document.getElementById('server').innerHTML = info.staff.os_staff_real_name;
					}
					document.getElementById('serverPeople').addEventListener('tap', function(){
						plus.device.dial(info.staff.os_staff_phone, false);
					})
					if(info.pay){
						document.getElementById('price').innerHTML = info.pay.op_actual_price + '元';
					}

					var bottomBtn = document.getElementById('bottomButton');
					var prompt = document.getElementById('prompt');
					var serverPeople = document.getElementById('serverPeople');
					if(info.ob_status == 1 || info.ob_status == 2) {
						bottomBtn.setAttribute('class', 'mui-btn mui-pull-right');
						serverPeople.setAttribute('class', 'mui-hidden');
						bottomBtn.innerHTML = '取消订单';
						prompt.innerHTML = '等待商家确认订单,请耐心等候.';
						bottomBtn.addEventListener('tap', function() {
							mui('#sheet1').popover('show');
						})
					} else if(info.ob_status == 6 || info.ob_status == 7) {
						bottomBtn.setAttribute('class', 'mui-btn mui-pull-right');
						bottomBtn.innerHTML = '去评价';
						prompt.innerHTML = '待评价';
						document.getElementById('price').setAttribute('class', 'mui-hidden');
					} else if(info.ob_status == 5) {
						bottomBtn.setAttribute('class', 'mui-btn mui-pull-right');
						bottomBtn.innerHTML = '去支付';
						prompt.innerHTML = '待付款';
						bottomBtn.addEventListener('tap', function(){
							createOrder(info.ob_number);
						})
					} else if(info.ob_status == 3) {
						prompt.innerHTML = '商家已指派工作人员.';
					} else if(info.ob_status == 4) {
						prompt.innerHTML = '工作人员已在工作中.';
					} else if(info.ob_status == 8 || info.ob_status == 14) {
						prompt.innerHTML = '已完成！';
					} else if(info.ob_status == 12) {
						prompt.innerHTML = '商家已取消订单！' + info.ob_enterprise_cancel_remark;
						serverPeople.setAttribute('class', 'mui-hidden');
					} else if(info.ob_status == 13) {
						prompt.innerHTML = '用户已取消订单！' + info.ob_client_cancel_remark;
						serverPeople.setAttribute('class', 'mui-hidden');
					}
				})
			}

			function cancelOrder(reason) {
				var self = plus.webview.currentWebview();
				var ob_id = self.order_id || '';
				var cacelParam = {
					service: 'Hlbr365app.Order.CancelOrder',
					ob_id: ob_id,
					remark: reason
				}
				wAjax(cacelParam, function() {
					var orderList = self.opener();
					orderList.reload();
					mui.back();
				})
			}
			
			mui("#sheet1").on('tap', 'a', function(e) {
				var reason = this.innerHTML;
				cancelOrder(reason);
			});
			
			function createOrder(ob_number){
				var createOrderParam = {
					service: 'Hlbr365app.Order.PayOrder',
					ob_number: ob_number,
					op_pay_mode: 3
				}
				wAjax(createOrderParam, function(result){
					var html = result.data.info;
					console.log(html);
					document.getElementById('submitOrder').innerHTML = html;
					setTimeout(function(){
						document.forms['alipaysubmit'].submit();
					}, 500);
//					aliUrl = result.data.info.ali;
//					payOrder(ob_number);
				})
			}


			var pays = [], aliUrl = '';
			function payOrder(ob_number) {
//				createOrder(ob_number);
				
				
				plus.payment.getChannels(function(channels) {
//					var content = document.getElementById('dcontent');
//					var info = document.getElementById('info');
//					var txt = '支付通道信息：';
					for(var i in channels) {
						var channel = channels[i];
						if(channel.id == 'qhpay' || channel.id == 'qihoo') { // 过滤掉不支持的支付通道：暂不支持360相关支付
							continue;
						}
						pays[channel.id] = channel;
//						txt += 'id:' + channel.id + ', ';
//						txt += 'description:' + channel.description + ', ';
//						txt += 'serviceReady:' + channel.serviceReady + '； ';
//						var de = document.createElement('div');
//						de.setAttribute('class', 'button');
//						de.setAttribute('onclick', 'pay(this.id)');
//						de.id = channel.id;
//						de.innerText = channel.description + '支付';
//						content.appendChild(de);
						if(channel.id == 'alipay'){
							checkServices(channel);
						}
						
					}
//					info.innerText = txt;
				}, function(e) {
					outLine('获取支付通道失败：' + e.message);
				});
			}

				var w = null;
			var PAYSERVER = 'http://365gateway.lanyukj.cn/public/index.php?';
			
			// 检测是否安装支付服务
			function checkServices(pc) {
				if(!pc.serviceReady) {
					var txt = null;
					switch(pc.id) {
						case 'alipay':
							txt = '检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，是否立即安装？';
							break;
						default:
							txt = '系统未安装“' + pc.description + '”服务，无法完成支付，是否立即安装？';
							break;
					}
					plus.nativeUI.confirm(txt, function(e) {
						if(e.index == 0) {
							pc.installService();
						}
					}, pc.description);
				} else {
					pay('alipay', document.getElementById('price').innerHTML);
				}
			}
			
			// 支付
			function pay(id, price) {
				if(w) {
					return;
				} //检查是否请求订单中
//				if(id === 'appleiap') {
//					outSet('应用内支付');
//					clicked('payment_iap.html');
//					return;
//				}
//				outSet('----- 请求支付 -----');
				var url = PAYSERVER;
//				if(id == 'alipay' || id == 'wxpay') {
//					url += id;
//				} else {
//					plus.nativeUI.alert('当前环境不支持此支付通道！', null, '捐赠');
//					return;
//				}
//				var appid = plus.runtime.appid;
//				if(navigator.userAgent.indexOf('StreamApp') >= 0) {
//					appid = 'Stream';
//				}
//				url += '&appid=' + appid + '&total=';
				url += aliUrl;
				w = plus.nativeUI.showWaiting();
				// 请求支付订单
				var amount = price;
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function() {
					switch(xhr.readyState) {
						case 4:
							w.close();
							w = null;
							if(xhr.status == 200) {
								console.log('----- 请求订单成功 -----');
								console.log(xhr.responseText);
								var order = xhr.responseText;
								plus.payment.request(pays[id], order, function(result) {
									console.log('----- 支付成功 -----');
									console.log(JSON.stringify(result));
									plus.nativeUI.alert('支付成功：感谢你的支持，我们会继续努力完善产品。', function() {
										back();
									}, '捐赠');
								}, function(e) {
									console.log('----- 支付失败 -----');
									console.log('[' + e.code + ']：' + e.message);
									plus.nativeUI.alert('更多错误信息请参考支付(Payment)规范文档：http://www.html5plus.org/#specification#/specification/Payment.html', null, '支付失败：' + e.code);
								});
							} else {
								console.log('----- 请求订单失败 -----');
								console.log(xhr.status);
								plus.nativeUI.alert('获取订单信息失败！', null, '捐赠');
							}
							break;
						default:
							break;
					}
				}
				xhr.open('GET', url);
				console.log('请求支付订单：' + url );
				xhr.send();
			}
		</script>
	</body>

</html>